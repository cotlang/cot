// std_io â€” Tests for stdlib modules: fs, os, time, random
// Zig-familiar API: error unions, catch, defer

import "std/fs"
import "std/os"
import "std/sys"
import "std/time"
import "std/random"

// ===== fs tests =====

test "fs: openFile and close" {
    var f = openFile("/dev/null", O_RDONLY)
    @assert(f.fd > 2)
    defer f.close()
    @assertEq(f.isValid(), 1)
}

test "fs: write and read back" {
    var f = createFile("/tmp/cot_std_fs_test")
    @assert(f.fd > 2)
    defer f.close()
    var n = f.writeAll("hello") catch 0 - 1
    @assertEq(n, 5)

    var f2 = openFile("/tmp/cot_std_fs_test", O_RDONLY)
    @assert(f2.fd > 2)
    defer f2.close()
    var buf = alloc(0, 16)
    defer dealloc(buf)
    var nr = f2.read(buf, 5) catch 0 - 1
    @assertEq(nr, 5)
}

test "fs: writeAll" {
    var f = createFile("/tmp/cot_std_fs_writeall")
    @assert(f.fd > 2)
    defer f.close()
    var n = f.writeAll("hi") catch 0 - 1
    @assertEq(n, 2)
}

test "fs: seekTo" {
    var f = createFile("/tmp/cot_std_fs_seekto")
    @assert(f.fd > 2)
    defer f.close()
    var n = f.writeAll("abcde") catch 0 - 1
    @assertEq(n, 5)
    var pos = f.seekTo(0) catch 0 - 1
    @assertEq(pos, 0)
}

test "fs: getPos" {
    var f = createFile("/tmp/cot_std_fs_getpos")
    @assert(f.fd > 2)
    defer f.close()
    var n = f.writeAll("abcde") catch 0 - 1
    @assertEq(n, 5)
    var pos = f.getPos() catch 0 - 1
    @assertEq(pos, 5)
}

test "fs: seekBy" {
    var f = createFile("/tmp/cot_std_fs_seekby")
    @assert(f.fd > 2)
    defer f.close()
    var n = f.writeAll("abcdefgh") catch 0 - 1
    @assertEq(n, 8)
    f.seekTo(2) catch 0 - 1
    var pos = f.seekBy(3) catch 0 - 1
    @assertEq(pos, 5)
}

test "fs: isValid for good fd" {
    var f = openFile("/dev/null", O_RDONLY)
    @assert(f.fd > 2)
    defer f.close()
    @assertEq(f.isValid(), 1)
}

test "fs: isValid for bad fd" {
    var f = File { .fd = 0 - 2 }
    @assertEq(f.isValid(), 0)
}

test "fs: constants are correct" {
    @assertEq(O_RDONLY, 0)
    @assertEq(O_WRONLY, 1)
    @assertEq(O_RDWR, 2)
    @assertEq(SEEK_SET, 0)
    @assertEq(SEEK_CUR, 1)
    @assertEq(SEEK_END, 2)
}

test "fs: createFile convenience" {
    var f = createFile("/tmp/cot_std_fs_create")
    @assert(f.fd > 2)
    defer f.close()
    var n = f.writeAll("test") catch 0 - 1
    @assertEq(n, 4)
}

test "fs: stdin fd is 0" {
    var f = stdin()
    @assertEq(f.fd, 0)
}

test "fs: stdout fd is 1" {
    var f = stdout()
    @assertEq(f.fd, 1)
}

test "fs: stderr fd is 2" {
    var f = stderr()
    @assertEq(f.fd, 2)
}

// ===== os tests =====

test "os: argsCount >= 1" {
    @assert(argsCount() >= 1)
}

test "os: argLen(0) > 0" {
    @assert(argLen(0) > 0)
}

test "os: argPtr(0) > 0" {
    @assert(argPtr(0) > 0)
}

test "os: environCount >= 1" {
    @assert(environCount() >= 1)
}

test "os: environLen(0) > 0" {
    @assert(environLen(0) > 0)
}

test "os: environPtr(0) > 0" {
    @assert(environPtr(0) > 0)
}

// ===== time tests =====

test "time: constants" {
    @assertEq(ns_per_ms, 1000000)
    @assertEq(ns_per_s, 1000000000)
    @assertEq(ms_per_s, 1000)
}

test "time: nanoTimestamp > epoch" {
    @assert(nanoTimestamp() > 1000000000)
}

test "time: milliTimestamp > 0" {
    @assert(milliTimestamp() > 0)
}

test "time: timestamp > 0" {
    @assert(timestamp() > 0)
}

test "time: monotonic increasing" {
    var t1 = nanoTimestamp()
    var t2 = nanoTimestamp()
    @assert(t2 >= t1)
}

test "time: Timer elapsed" {
    var now = nanoTimestamp()
    var t = Timer { .start_time = now }
    var e = t.elapsed()
    @assert(e >= 0)
}

test "time: Timer reset" {
    var now = nanoTimestamp()
    var t = Timer { .start_time = now }
    t.reset()
    var e = t.elapsed()
    @assert(e >= 0)
}

// ===== random tests =====

test "random: fillBytes success" {
    var buf = alloc(0, 16)
    defer dealloc(buf)
    var result = fillBytes(buf, 16)
    @assertEq(result, 0)
}

test "random: randomInt runs" {
    var val = randomInt()
    @assert(val == val)
}

test "random: randomRange bounds" {
    var val = randomRange(10)
    @assert(val >= 0)
    @assert(val < 10)
}

test "random: randomRange(1) == 0" {
    @assertEq(randomRange(1), 0)
}

// ===== high-level os tests =====

test "os: arg(0) is non-empty string" {
    var a = arg(0)
    @assert(@lenOf(a) > 0)
}

test "os: env(0) is non-empty string" {
    var e = env(0)
    @assert(@lenOf(e) > 0)
}

// ===== high-level fs tests =====

test "fs: writeFile and readFile" {
    writeFile("/tmp/cot_std_readwrite.txt", "hello world")
    var content = readFile("/tmp/cot_std_readwrite.txt") catch ""
    @assertEq(@lenOf(content), 11)
}

test "fs: readFile reads correct content" {
    writeFile("/tmp/cot_std_readback.txt", "abc")
    var content = readFile("/tmp/cot_std_readback.txt") catch ""
    @assert(content == "abc")
}
